<head>
  <!-- include a-frame -->
  <script src='./vendor/aframe/build/aframe.min.js'></script>

  <!-- include ar.js for aframe -->
  <script src='./build/aframe-ar.js'></script>
  <script>ARjs.Context.baseURL = './three.js/'</script>
  <!-- include shadowonly-plane -->
  <script src='./build/aframe-shadow-plane.js'></script>

  <link rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css"/>
  <link rel="stylesheet" href="./styles.css">
</head>
<body style='margin : 0px; overflow: hidden;'>
	<!-- Define your scene -->
	<a-scene antialias="true" embedded arjs='trackingMethod: best; debugUIEnabled: false;' vr-mode-ui="enabled: false">
		<a-assets>
			<a-asset-item id='bercik-obj' src='./models/hubert/bercik.obj'></a-asset-item>
			<a-asset-item id='bercik-mtl' src='./models/hubert/bercik.mtl'></a-asset-item>
		</a-assets>		
		<!-- Create a anchor to attach your augmented reality -->
		<a-anchor hit-testing-enabled='true' shadow="type: pcfsoft">
      <a-entity obj-model="obj: #bercik-obj; mtl: #bercik-tml" scale="0.1 0.1 0.1"></a-entity>
		</a-anchor>
		<!-- Define a static camera -->
		<a-camera-static/>
	</a-scene>
  <img id="screenshot" src="" class="hide"/>
  <canvas id="screenshotCanvas" class="hide"></canvas>
  <div class="controls onVideo">
    <i id="takeScreenshot" class="icon ion-camera action"></i>
  </div>
  <div class="controls onScreenshot hide">
    <i id="accept" class="icon ion-checkmark action"></i>
    <i id="retake" class="icon ion-close action"></i>
  </div>
  <div id="tweetInput" class="hide">
    <div>
      <textarea id="statusText" placeholder="your tweet here, remember to add hashtags #devoxx #voucherify"></textarea><!-- #hashtags -->
      <div id="counter">0/280</div>
      <button id="tweet">Tweet</button>
    </div>
  </div>
  <div id="loader" class="hide">
    <i class="icon ion-refresh"></i>
  </div>
  <div id="message" class="hide"></div>
  <script>
    let videoElement = null
    const getVideoElement = () => new Promise(resolve => {
      videoElement = document.querySelector('video')
      if (videoElement) {
        resolve(videoElement);
        return
      }

      setTimeout(() => resolve(getVideoElement()), 300)
    })
    document.addEventListener('DOMContentLoaded', () => {
      const screenshotImage = document.getElementById('screenshot')
      const screenshotButton = document.getElementById('takeScreenshot')
      const videoControls = document.querySelector('.controls.onVideo')
      const screenshotControls = document.querySelector('.controls.onScreenshot')
      const accept = document.getElementById('accept')
      const retake = document.getElementById('retake')
      const canvas = document.getElementById('screenshotCanvas')
      const tweetInput = document.getElementById('tweetInput')
      const statusText = document.getElementById('statusText')
      const tweet = document.getElementById('tweet')
      const counter = document.getElementById('counter')
      const loader = document.getElementById('loader')

      const videoScreenshot = (video, canvas, box) => {
        const context = canvas.getContext('2d')
        context.drawImage(video, box.x, box.y, box.width, box.height, 0, 0, box.width, box.height)
      }
      const sceneScreenshot = (videoCanvas, destinationCanvas, box) => {
        const scene = document.querySelector('a-scene')
        const {width, height} = videoCanvas
        scene.components.screenshot.data.width = width
        scene.components.screenshot.data.height = height
        const sceneCanvas = scene.components.screenshot.getCanvas('perspective')

        const context = destinationCanvas.getContext('2d')
        context.drawImage(sceneCanvas, box.x, box.y, box.width, box.height, 0, 0, box.width, box.height)
      }
      const takeScreenshot = () => getVideoElement().then(video => {
        // there is some scaling involved in the AR video, we need to apply the same logic to canvas
        const topOffset = -parseFloat(video.style['margin-top'])
        const leftOffset = -parseFloat(video.style['margin-left'])
        const relativeTopOffset = topOffset / parseFloat(video.style.height)
        const relativeLeftOffset = leftOffset / parseFloat(video.style.width)

        const {videoWidth: width, videoHeight: height} = video
        const box = {
          x: width*relativeLeftOffset,
          y: height*relativeTopOffset,
          width: width*(1-2*relativeLeftOffset),
          height: height*(1-2*relativeTopOffset)
        }
        canvas.width = box.width
        canvas.height = box.height
        videoScreenshot(video, canvas, box)
        sceneScreenshot({width, height}, canvas, box)

        const imageData = canvas.toDataURL('image/png')
        screenshotImage.setAttribute('src', imageData)
      })

      const hide = element => { element.className = element.className.includes('hide') ? element.className : `${element.className} hide` }
      const show = element => { element.className = element.className.replace('hide', '') }

      window.takeScreenshot = takeScreenshot
      screenshotButton.addEventListener('click', () => {
        takeScreenshot()
        show(screenshotImage)
        hide(videoControls)
        show(screenshotControls)
      })

      const backToCamera = () => {
        hide(screenshotImage)
        hide(screenshotControls)
        hide(tweetInput)
        statusText.value = ''
        show(videoControls)
      }

      retake.addEventListener('click', backToCamera)

      accept.addEventListener('click', () => {
        show(tweetInput)
      })

      const OUR_PREFIX = '#devoxx #voucherify ' // #hashtags

      statusText.addEventListener('keydown', () => {
        if (!statusText.value.length) {
          statusText.value = OUR_PREFIX
        }
      })

      statusText.addEventListener('keyup', () => {
        if (statusText.value.length > 280) {
          counter.innerHTML = `your tweet will be truncated! ${statusText.value.length}/280`
          counter.style.color = 'red'
          return
        }

        counter.innerHTML = `${statusText.value.length}/280`
        counter.style.color = 'white'
      })

      tweet.addEventListener('click', () => canvas.toBlob(blob => {
        statusText.disabled = true
        tweet.disabled = true
        const formData = new FormData()
        formData.append('status', statusText.value)
        formData.append('screenshot', blob)
        show(loader)

        fetch('/api/tweet', {
          method: 'POST',
          body: formData,
          credentials: 'same-origin',
        })
          .then(() => {
            hide(loader)
            message('success', 'Nice! Keep it up, go get them all!')
            backToCamera()
          })
          .catch(error => {
            hide(loader)
            message('error', 'Whoops, something went wrong, try again in a sec!')
            backToCamera()
          })
      }))

      function message(style, text, hideAfter = 2000) {
        const messageContainer = document.getElementById('message')

        messageContainer.className += ' ' + style
        messageContainer.innerHTML = text

        show(messageContainer)

        setTimeout(() => {
          hide(messageContainer)
          messageContainer.className = messageContainer.replace(style, '')
          messageContainer.innerHTML = ''
        }, hideAfter)
      }
    })
  </script>
</body>
